<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Starburst | Impersonation troubleshooting guide</title>
    <meta name="viewport" content="width=device-width">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Starburst - Impersonation troubleshooting guide">
    <meta property="og:description" content="Your hub to all knowledge about Starburst products.">
    <meta property="og:image" content="/assets/img/logo/starburst-reverse.png">

    <link rel="stylesheet" href="/assets/fontawesome/css/all.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/mdb.min.css">
    <link rel="stylesheet" href="/assets/css/highlight.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
<div class="wrap">
  <header style="padding-top:74px;">
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <a class="navbar-brand" href="/index.html">
      <img src="/assets/img/logo/starburst-reverse.png" height="40" alt=" Starburst">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/starburst-enterprise/index.html">Starburst Enterprise</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/marketplace/index.html">Marketplace deployments</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/starburst-galaxy/index.html">Starburst Galaxy</a>
        </li>
      </li>
      
      <li class="dropdown" id="site-search">
  <a id="dropdownSearch" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <i class="fa fa-search" style="color:white; vertical-align: sub;"></i>
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdownSearch">
    <div id="search-container">
      <div id="search-input-bar">
        <input type="text" id="search-input" name="search" placeholder="Search..." />
      </div>
      <div id="results-container"></div>
    </div>
  </div>
</li>

<script type="text/javascript" src="/assets/js/simple-jekyll-search.js"></script>
<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('results-container'),
  json: '/search.json',
  limit: 30
})
</script>

      
      </ul>
    </div>
  </nav>
</header>

  
  <div class="content">
    <div class="row">
      <div class="col-md-3 side-navigation">
        <div class="spacer-60 toc-sticky left-nav">
          
          <div>
  <h6 class="overline product-nav-title">Resources</h6>
</div>
<hr />

 
  
<li >
  <a href="/starburst-enterprise/index.html" >Starburst Enterprise</a>
</li>



 
  
<li >
  <a href="/marketplace/index.html" >Marketplace deployments</a>
</li>



 
  
<li >
  <a href="/starburst-galaxy/index.html" >Starburst Galaxy</a>
</li>



 
<li ><a onclick="toggle_visibility('personas');">User personas <i class="fa fa-angle-down nav-icon"></i></a></li>
<ul id="personas" class="doc-subnav hidden">
  
  
    
  <li >
    <a href="/starburst-personas.html" >Overview</a>
  </li>
  
  
  
    
  <li >
    <a href="/data-consumer/index.html" >Data consumer</a>
  </li>
  
  
  
    
  <li >
    <a href="/data-engineer/index.html" >Data engineer</a>
  </li>
  
  
  
    
  <li >
    <a href="/platform-administrator/index.html" >Platform administrator</a>
  </li>
  
  
  
    
  <li >
    <a href="/data-leader/index.html" >Data leader</a>
  </li>
  
  
</ul>



 
  
<li >
  <a href="/knowledge-base/index.html" >Knowledge base</a>
</li>



 
  
<li >
  <a href="/glossary.html" >Glossary</a>
</li>



 
  
<li >
  <a href="https://docs.starburst.io/latest/index.html" >Reference documentation</a>
</li>



          
        </div>
      </div>
      <div class="col-md-9 col-lg-6 spacer-30 docs-content">
        



<div class="breadcrumbs">
  <p>
  
  
    
      <a href="/knowledge-base/"
        style="text-transform: uppercase"
      > knowledge base</a> >
    
  
    
      Impersonation troubleshooting guide
    
  </p>
</div>

        <p>Overview
Starburst utilizes an impersonation model with several distinct entities at
different stages of authentication and authorization. Additionally,
impersonation can take place in the underlying data source, as a common use case
for Starburst is to authenticate using the credentials of a privileged service
user, and then to execute subsequent queries with the permissions of the end
user.</p>

<p>Error messages vary slightly depending on which layer of access control returns
the error (i.e. Starburst, Hadoop, or an RDBMS), so obtaining the full stack
trace from the Starburst server logs or web UI can help identify the source of
the issue.</p>

<p>The Error</p>

<p>Presto System Access Control Impersonation Errors</p>

<p>Concise error:
Query 20201231_211855_00002_a86vj failed: Access Denied: User <someuser> cannot impersonate user <otheruser></otheruser></someuser></p>

<p>Impersonation errors are subtly different depending on the source, so looking at
the full stack trace is necessary to confirm where the impersonation issue
originates from. In this case, the full stack trace is:</p>

<p>io.prestosql.spi.security.AccessDeniedException: Access Denied: User <someuser> cannot impersonate user <otheruser>
at io.prestosql.spi.security.AccessDeniedException.denyImpersonateUser(AccessDeniedException.java:43)
at io.prestosql.spi.security.AccessDeniedException.denyImpersonateUser(AccessDeniedException.java:38)
at io.prestosql.plugin.base.security.DefaultSystemAccessControl.checkCanImpersonateUser(DefaultSystemAccessControl.java:58)
at 
…</otheruser></someuser></p>

<p>We can see io.prestosql.security.AccessControlManager in the stack trace,
indicating that this is coming from access control checks in Presto itself.  The
authenticated user <someuser> is not allowed impersonate the user <otheruser>
due to system-level access control checks. This can be resolved by adding the
appropriate impersonation rules using either file-based access control or
system-level Ranger policies.</otheruser></someuser></p>

<p>HMS/HDFS Impersonation Errors</p>

<p>Concise error:
Query 20201213_115327_00001_chwrt failed: User: <someprincipal> is not allowed to impersonate <enduser></enduser></someprincipal></p>

<p>This looks very similar to the previous example, but with slightly different
wording. This error message comes from Hadoop, and typically occurs when using
user impersonation with either the Hive Metastore or HDFS. Looking at the stack
trace will reveal the source of the issue.</p>

<p>HMS:
io.prestosql.spi.PrestoException: 
User: <someprincipal> is not allowed to impersonate <enduser>
at io.prestosql.plugin.hive.metastore.thrift.ThriftHiveMetastore.loadDelegationToken(ThriftHiveMetastore.java:2011)</enduser></someprincipal></p>

<p>HDFS:
io.prestosql.spi.PrestoException: 
Failed to list directory: hdfs://warehouse/data/database/table/partition=value
at
…
Caused by: org.apache.hadoop.ipc.RemoteException: 
User: <someprincipal> is not allowed to impersonate <someuser>
at org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1511)</someuser></someprincipal></p>

<p>The first thing to check is the proxy user settings in your Hadoop cluster. The
principal that Presto is using to connect to Hadoop services must be configured
as a proxy user on the Hadoop side in order to be allowed to impersonate end
users.</p>

<p>Note: If you user Active Directory to Kerberize your Hadoop cluster, there is a
bug in Java 11 related to Kerberos principal canonicalization that may be
involved. If you see an error message that looks like</p>

<p>io.prestosql.spi.PrestoException: User: $V9H200-TAD2F4IK2G09@EXAMPLE.COM is not allowed to impersonate <enduser></enduser></p>

<p>If the principal $V9H200-TAD2F4IK2G09@EXAMPLE.COM looks randomly generated and
does not match the principals configured to connect to HMS and HDFS, then check
your JDK version, and upgrade to 11.0.9+ if it is older than that.</p>

<p>RDBMS Impersonation Errors
If the data source is something other than HDFS, there will be a message
specific to the RDMS related to the impersonation issue. For instance Teradata
will give an error that looks like:</p>

<p>Query 20200512_131008_00023_hjfre failed: [Teradata Database] [TeraJDBC 16.10.00.05] [Error 9203] [SQLState HY000] Connect Through has not been granted to ENDUSER through SERVICE_USER.</p>

<p>This indicates that the service user whose credentials are used to make the
initial connection to Teradata lacks the CONNECT THROUGH permissions to
impersonate the end user. Consult your DBA to grant the appropriate permissions
to the service user.</p>

      </div>
      <div class="col-lg-3 toc-styles d-none d-lg-block">
        <div class="spacer-60 toc-sticky">
          

        </div>
      </div>
  </div>
  
</div>
<footer class="page-footer">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <p style="font-weight:900">Resources</b></p>
        <ul>
          <li class="footer-item"><a href="https://docs.starburst.io/latest/index.html">Starburst Enterprise reference documentation</a></li>
          <li class="footer-item"><a href="/knowledge-base/index.html">Knowledge base</a></li>
          <li class="footer-item"><a href="/glossary.html">Glossary</a></li>
          <li class="footer-item"><a href="https://www.starburstdata.com/oreilly-presto-guide-download/" target="_blank">Free O'Reilly book - Presto: The Definitive Guide</a></li>
          <li class="footer-item"><a href="https://prestosql.io/broadcast/" target="_blank">Trino Community Broadcast</a></li>
          <li class="footer-item"><a href="https://blog.starburstdata.com/" target="_blank">Starburst blog</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <p style="font-weight:900">Contact and more</p>
        <ul>
          <li class="footer-item"><a href="https://www.starburstdata.com/weekly-demo-registration/" target="_blank">Join our weekly demos</a></li>
          <li class="footer-item"><a href="https://www.starburstdata.com/#!" target="_blank">Start a trial</a></li>
          <li class="footer-item"><a href="https://starburstsupport.force.com/s/" target="_blank">Get support</a></li>
          <li class="footer-item"><a href="https://www.starburstdata.com/contact/" target="_blank">Contact us</a></li>
        </ul>
      </div>
      <div class="col-md-3" style="text-align:right;">
        <img src="/assets/img/logo/starburst-reverse.png" height="60" alt=" Starburst" style="margin-bottom:20px;">
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#copyright">Copyright © 2017-2021<br> Starburst Data</a>
        </li>
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#trademarks">Trademark information</a>
        </li>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 center spacer-30">
          <a href="https://twitter.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-twitter"></i></a>
          <a href="https://linkedin.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-linkedin"></i></a>
          <a href="https://www.youtube.com/channel/UCXjkuWSO9CV_cSI3Mvo4a4w" target="_blank" class="footer-icon"><i class="fab fa-youtube"></i></a>
          <a href="https://github.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-github"></i></a>
      </div>
    </div>
  </div>
</footer>


  <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/js/popper.min.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/assets/js/mdb.min.js"></script>
  <script type="text/javascript" src="/assets/js/custom.js"></script>
</body>
</html>