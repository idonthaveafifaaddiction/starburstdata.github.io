<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Starburst | Adding a UDF to Presto</title>
    <meta name="viewport" content="width=device-width">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Starburst - Adding a UDF to Presto">
    <meta property="og:description" content="Your hub to all knowledge about Starburst products.">
    <meta property="og:image" content="/assets/img/logo/starburst-reverse.png">

    <link rel="stylesheet" href="/assets/fontawesome/css/all.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/mdb.min.css">
    <link rel="stylesheet" href="/assets/css/highlight.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
<div class="wrap">
  

<header style="padding-top:74px;">
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <a class="navbar-brand" href="/index.html">
      <img src="/assets/img/logo/starburst-reverse.png" height="40" alt=" Starburst">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a  class="nav-link"  href="/starburst-enterprise/index.html">Starburst Enterprise</a>
        </li>
        <li class="nav-item">
          <a  class="nav-link"  href="/marketplace/index.html">Marketplace deployments</a>
        </li>
        <li class="nav-item">
          <a  class="nav-link"  href="/starburst-galaxy/index.html">Starburst Galaxy</a>
        </li>
      </li>
      
      <li class="dropdown" id="site-search">
  <a id="dropdownSearch" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <i class="fa fa-search" style="color:white; vertical-align: sub;"></i>
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdownSearch">
    <div id="search-container">
      <div id="search-input-bar">
        <input type="text" id="search-input" name="search" placeholder="Search..." />
      </div>
      <div id="results-container"></div>
    </div>
  </div>
</li>

<script type="text/javascript" src="/assets/js/simple-jekyll-search.js"></script>
<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('results-container'),
  json: '/search.json',
  limit: 30
})
</script>

      
      </ul>
    </div>
  </nav>
</header>

  
  <div class="content">
    <div class="row">
      <div class="col-md-3 side-navigation">
        <div class="spacer-60 toc-sticky left-nav">
          
          <div>
  <h6 class="overline product-nav-title">Resources</h6>
</div>
<hr />

 
  
  
<li >
  <a href="/starburst-enterprise/index.html" >Starburst Enterprise</a>
</li>



 
  
  
<li >
  <a href="/marketplace/index.html" >Marketplace deployments</a>
</li>



 
  
  
<li >
  <a href="/starburst-galaxy/index.html" >Starburst Galaxy</a>
</li>



 
<li >
  <a onclick="toggle_navigation_visibility('personas');">
    User personas
    <i class="fa fa-angle-left nav-icon"></i>
  </a>
</li>
<ul id="personas" class="doc-subnav hidden">
  
  
    
    
  <li >
    <a href="/starburst-personas.html" >Overview</a>
  </li>
  
  
  
    
    
  <li >
    <a href="/data-consumer/index.html" >Data consumer</a>
  </li>
  
  
  
    
    
  <li >
    <a href="/data-engineer/index.html" >Data engineer</a>
  </li>
  
  
  
    
    
  <li >
    <a href="/platform-administrator/index.html" >Platform administrator</a>
  </li>
  
  
  
    
    
  <li >
    <a href="/data-leader/index.html" >Data leader</a>
  </li>
  
  
</ul>



 
  
  
<li >
  <a href="https://docs.starburst.io/latest/index.html" >Reference documentation</a>
</li>



 
  
  
<li >
  <a href="/glossary.html" >Glossary</a>
</li>



 
  
  
<li >
  <a href="/knowledge-base/index.html" >Knowledge base</a>
</li>



          
        </div>
      </div>
      <div class="col-md-9 col-lg-6 spacer-30 docs-content">
        



<div class="breadcrumbs">
  <p>
  
  
    
      <a href="/knowledge-base/"
        style="text-transform: uppercase"
      > knowledge base</a> >
    
  
    
      Adding a UDF to Presto
    
  </p>
</div>

        <h1 id="adding-a-udf-to-presto">
        
        
          Adding a UDF to Presto <a href="#adding-a-udf-to-presto" class="titleAnchor">#</a>
        
        
      </h1>
    

<p>Presto allows the addition of User Defined Functions (UDFs) written as Java
packages. The framework Presto uses is distinct from Hive, but Hive UDFs can
typically be transferred into this framework with a minimal amount of
modification.</p>

<p>Note: an example UDF is available in this GitHub repository to supplement this
article.</p>

<p>The first step in creating your UDFs is to pick a name for the package they will
be a part of. For this example, I will use the name presto-stringfunctions.
Then, create a directory structure corresponding to the package structure we’re
using:</p>

<p>$ mkdir -p presto-stringfunctions/src/main/java/io/prestosql/stringfunctions/</p>

<p>If you’ve cloned the Presto repository, you can put the presto-stringfunctions
directory alongside all of the other presto-* directories under the presto root.
Next, we’ll need a pom.xml describing this package. You can use this pom.xml to
create a UDF without cloning the entire Presto repository. If you have cloned
the Presto repository, you can copy the pom.xml file from the
presto-teradata-functions package to use as example. If you do this, all you
need to change is the artifactId (for this example, my artifactId would become
presto-stringfunctions), and remove a few dependencies specific to that package,
which are io.airlift.concurrent, joda-time.joda-time, and
org.antlr.antlr4-runtime. Either way should work just fine.</p>

<p>The important part of the pom.xml file, besides the dependencies, is the</p>
<packaging>presto-plugin</packaging>
<p>tag, which will create artifacts that
Presto can use as a plugin. Note that the pom.xml file for the standalone UDF
has disabled the git checkin plugin. You can reenable this if you would like to
have Maven check your UDF into your own repository. If you have not cloned the
Presto repository, you will have to do one additional step to allow the Maven
violations plugin to work correctly:</p>

<p>$ mkdir presto-stringfunctions/src/modernizer
$ aws s3 cp s3://starburstdata/support/example_udf/violations.xml presto-stringfunctions/src/modernizer</p>

<p>With that taken care of, we can start writing some functions. The particular
functions I’m adding compare strings, so let’s create a
StringComparisonFunctions class. We can always add more classes later. To the
stringfunctions directory we created above, add a file named
StringComparisonFunctions.java consisting of</p>

<p>package io.prestosql.stringfunctions;</p>

<p>public final class StringComparisonFunctions
{
}</p>

<p>At this point, I’d like to import the pom.xml into my Presto project in
IntelliJ. IntelliJ, or your IDE of choice, is helpful for making sure the
annotations and types needed for this UDF to work in Presto are correct.
PrestoSQL has strict style checking, so I recommend installing the Airlift code
style for IntelliJ.  Additionally, you will likely need to add the Apache
License to your classes in order to build your plugin.</p>

<p>Now, let’s add our first function. We’ll add three annotations to the function
to specify the name, return type, and a description:</p>

<p>@Description(“Checks if two strings are anagrams of one another.”)
@ScalarFunction(“are_anagrams”)
@SqlType(StandardTypes.BOOLEAN)</p>

<p>Next, we will add a function signature with our inputs, including annotations
specifying the SQL input types, and the session information:</p>

<p>public static boolean are_anagrams(ConnectorSession session,
    @SqlType(StandardTypes.VARCHAR) Slice string1,
    @SqlType(StandardTypes.VARCHAR) Slice string2)</p>

<p>Now, let’s put it all together with the actual function logic, a constructor,
and all the necessary imports:</p>

<p>package io.prestosql.stringfunctions;</p>

<p>import io.airlift.slice.Slice;
import io.prestosql.spi.connector.ConnectorSession;
import io.prestosql.spi.function.Description;
import io.prestosql.spi.function.ScalarFunction;
import io.prestosql.spi.function.SqlType;
import io.prestosql.spi.type.StandardTypes;</p>

<p>import java.util.Arrays;</p>

<p>public final class StringComparisonFunctions
{
   private StringComparisonFunctions()
   {
   }</p>

<p>@Description(“Checks if two strings are anagrams of one another.”)
   @ScalarFunction(“are_anagrams”)
   @SqlType(StandardTypes.BOOLEAN)</p>

<p>public static boolean are_anagrams(ConnectorSession session,
           @SqlType(StandardTypes.VARCHAR) Slice string1,
           @SqlType(StandardTypes.VARCHAR) Slice string2)
   {
       byte[] string1Sorted = string1.getBytes();
       Arrays.sort(string1Sorted);
       byte[] string2Sorted = string2.getBytes();
       Arrays.sort(string2Sorted);
       return Arrays.equals(string1Sorted, string2Sorted);
   }
}</p>

<p>This can almost be deployed into Presto, however we need one more class, which
Presto will call to list the functions available. This class should add all of
the classes in which you have declared UDFs. You can simply chain the add()
functions to add more.</p>

<p>package io.prestosql.stringfunctions;</p>

<p>import com.google.common.collect.ImmutableSet;
import io.prestosql.spi.Plugin;</p>

<p>import java.util.Set;</p>

<p>public class StringFunctionsPlugin
        implements Plugin
{
    @Override
    public Set&lt;Class&lt;?» getFunctions()
    {
        return ImmutableSet.&lt;Class&lt;?»builder()
                .add(StringComparisonFunctions.class)
                .build();
    }
}</p>

<p>Ok, we are just about ready to rock! You can try running:</p>

<p>$ mvn clean package</p>

<p>from the presto-stringfunctions directory to compile this into a set of JAR
files you can add to your plugins folder in Presto. However, let’s cover one
last case: including external dependencies. To do this, you must add the
dependency to your pom.xml and import the package as you normally would. For
example, let’s say we want to add a Levenshtein Distance function to our
stringfunctions package. This is a somewhat complicated algorithm, so we will
just use the implementation from Apache Commons. We can do this by adding the
following to our pom.xml file, under the dependencies sections:</p>

<p><!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 -->
       <dependency>
           <groupId>org.apache.commons</groupId>
           <artifactId>commons-lang3</artifactId>
           <version>3.7</version>
       </dependency></p>

<p>And add the following to our code. First, in the imports section:</p>

<p>import org.apache.commons.lang3.StringUtils;</p>

<p>And then another function:</p>

<p>@Description(“Measure the Levenshtein distance between strings.”)
   @ScalarFunction(“lev_dist”)
   @SqlType(StandardTypes.INTEGER)</p>

<p>public static int lev_dist(ConnectorSession session,
                             @SqlType(StandardTypes.VARCHAR) Slice string1,
                             @SqlType(StandardTypes.VARCHAR) Slice string2)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   return StringUtils.getLevenshteinDistance(string1.toStringUtf8(), string2.toStringUtf8());
</code></pre></div></div>

<p>}</p>

<p>…and that’s it. This is done within the StringComparisonFunctions class, so no
need to change the StringFunctionsPlugin.</p>

<p>The very last step is deploying the UDF package. To do this, run the mvn package
command from the root of the presto-stringfunctions package. This will create a
target directory containing a presto-stringfunctions-<presto_version> directory
(as well as a .zip file with the same contents). Copy this directory to the
Presto plugin directory on every node (typically, /usr/lib/presto/plugin).
You're done! Next time you restart Presto (make sure you restart worker nodes as
well), your UDF should be visible and ready to use.</presto_version></p>

<p>If you’ve followed this walkthrough, you should be able to use the are_anagrams
and lev_dist functions in Presto:</p>

<p>presto&gt; select are_anagrams(‘listen’,’silent’);
_col0
——-
true</p>

<p>presto&gt; select lev_dist(‘listen’,’listerine’);
_col0
——-
    3</p>

      </div>
      <div class="col-lg-3 toc-styles d-none d-lg-block">
        <div class="spacer-60 toc-sticky">
          <ul><li><a href="#adding-a-udf-to-presto">Adding a UDF to Presto</a></li></ul>

        </div>
      </div>
  </div>
  
</div>
<footer class="page-footer">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <p style="font-weight:900">Resources</b></p>
        <ul>
          <li class="footer-item"><a href="https://docs.starburst.io/latest/index.html">Starburst Enterprise reference documentation</a></li>
          <li class="footer-item"><a href="/knowledge-base/index.html">Knowledge base</a></li>
          <li class="footer-item"><a href="/glossary.html">Glossary</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/info/oreilly-presto-guide/" target="_blank">Free O'Reilly book - Presto: The Definitive Guide</a></li>
          <li class="footer-item"><a href="https://trino.io/broadcast/" target="_blank">Trino Community Broadcast</a></li>
          <li class="footer-item"><a href="https://blog.starburstdata.com/" target="_blank">Starburst blog</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <p style="font-weight:900">Contact and more</p>
        <ul>
          <li class="footer-item"><a href="https://www.starburst.io" target="_blank">Starburst</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/info/starburst-intro-and-demo/" target="_blank">Join our weekly demos</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/#!" target="_blank">Start a trial</a></li>
          <li class="footer-item"><a href="https://starburstsupport.force.com/s/" target="_blank">Get support</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/contact/" target="_blank">Contact us</a></li>
        </ul>
      </div>
      <div class="col-md-3" style="text-align:right;">
        <a href="https://www.starburst.io/" target="_blank"><img src="/assets/img/logo/starburst-reverse.png" height="60" alt=" Starburst" style="margin-bottom:20px;"></a>
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#copyright">Copyright © 2017-2021<br> Starburst Data</a>
        </li>
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#trademarks">Trademark information</a>
        </li>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 center spacer-30">
          <a href="https://twitter.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-twitter"></i></a>
          <a href="https://linkedin.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-linkedin"></i></a>
          <a href="https://www.youtube.com/channel/UCXjkuWSO9CV_cSI3Mvo4a4w" target="_blank" class="footer-icon"><i class="fab fa-youtube"></i></a>
          <a href="https://github.com/starburstdata" target="_blank" class="footer-icon"><i class="fab fa-github"></i></a>
      </div>
    </div>
  </div>
</footer>


  <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/js/popper.min.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/assets/js/mdb.min.js"></script>
  <script type="text/javascript" src="/assets/js/custom.js"></script>
</body>
</html>